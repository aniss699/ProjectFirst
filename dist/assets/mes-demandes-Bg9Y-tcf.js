import{r as C,j as e}from"./ui-he1BrmUV.js";import{u as E}from"./useQuery-oh0pC5lG.js";import{g as P,u as k,i as z,j as D,k as q,B as i,l as j,p as f,C as S,b as _,f as B,c as T}from"./index-BF4d27uU.js";import{f as $}from"./categories-CJOmrs8V.js";import{B as M}from"./badge-ZjcmqZ31.js";import{C as F}from"./circle-alert-CFAE_YMC.js";import{F as g}from"./file-text-BIoBZSbk.js";import{E as I}from"./eye-D2FSwxqN.js";import{S as L}from"./square-pen-Dwy2Smmk.js";import{T as R}from"./trash-2-DkXa4-6v.js";import"./vendor-D3F3s8fL.js";function Y(){const{user:t}=P(),[,n]=k(),[c,d]=C.useState(null),b=z(),{toast:m}=D(),{data:x=[],isLoading:u,error:p}=E({queryKey:["userProjects",t?.id],queryFn:async()=>{if(!t?.id)throw new Error("User ID manquant");console.log("🔍 Récupération des projets pour user.id:",t.id);const s=await fetch(`/api/projects/users/${t.id}/projects`);if(!s.ok){const a=await s.text();throw console.error("❌ Erreur API projets:",s.status,a),new Error(`Erreur ${s.status}: ${a}`)}const r=await s.json();console.log("✅ Projets récupérés:",r.length);const l=await Promise.all(r.map(async a=>{try{const o=await fetch(`/api/projects/${a.id}/bids`);if(o.ok){const w=await o.json();return{...a,bids_count:w.length||0}}return{...a,bids_count:0}}catch(o){return console.error(`Erreur récupération offres projet ${a.id}:`,o),{...a,bids_count:0}}}));return console.log("✅ Projets avec détails:",l.length),l},enabled:!!t?.id,retry:2,retryDelay:1e3}),h=q({mutationFn:async s=>{const r=await fetch(`/api/projects/${s}`,{method:"DELETE"});if(!r.ok)throw new Error("Failed to delete project");return r.json()},onSuccess:()=>{b.invalidateQueries({queryKey:["userProjects"]}),m({title:"Projet supprimé",description:"Votre projet a été supprimé avec succès."})},onError:s=>{m({title:"Erreur",description:"Impossible de supprimer le projet.",variant:"destructive"})}}),v=s=>{window.confirm("Êtes-vous sûr de vouloir supprimer ce projet ?")&&h.mutate(s)},y=s=>{const r={draft:{label:"Brouillon",variant:"secondary"},published:{label:"Publié",variant:"default"},in_progress:{label:"En cours",variant:"secondary"},completed:{label:"Terminé",variant:"outline"}},l=r[s]||r.published;return e.jsx(M,{variant:l.variant,children:l.label})},N=s=>s==="0"?"Budget non spécifié":`${parseInt(s).toLocaleString()} €`;return console.log("👤 User actuel:",{id:t?.id,role:t?.role,email:t?.email}),t?e.jsxs("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 sm:py-8",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:justify-between sm:items-center gap-4 mb-6 sm:mb-8",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl sm:text-3xl font-bold text-gray-900 mb-1 sm:mb-2",children:"Mes Demandes"}),e.jsx("p",{className:"text-base sm:text-lg text-gray-600",children:"Consultez et gérez vos projets publiés"})]}),e.jsxs(i,{onClick:()=>n(f.createMission),size:"lg",className:"w-full sm:w-auto",children:[e.jsx(j,{className:"mr-2 h-4 w-4 sm:h-5 sm:w-5"}),"Nouveau Projet"]})]}),u&&e.jsxs("div",{className:"text-center py-12",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto mb-4"}),e.jsx("p",{className:"text-gray-500",children:"Chargement..."})]}),p&&e.jsxs("div",{className:"text-center py-12",children:[e.jsx(F,{className:"w-16 h-16 text-red-300 mx-auto mb-4"}),e.jsx("p",{className:"text-red-500 text-lg mb-4",children:"Erreur de chargement"}),e.jsx(i,{onClick:()=>window.location.reload(),variant:"outline",children:"Réessayer"})]}),!u&&!p&&e.jsx("div",{className:"space-y-6",children:x.length>0?x.map(s=>e.jsxs(S,{className:"hover:shadow-lg transition-shadow",children:[e.jsx(_,{children:e.jsxs("div",{className:"flex flex-col sm:flex-row sm:justify-between sm:items-start gap-4",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-2",children:[e.jsx(B,{className:"text-xl",children:s.title}),y(s.status||"published")]}),e.jsx("p",{className:"text-gray-600 text-sm sm:text-base line-clamp-3",children:s.description})]}),e.jsxs("div",{className:"text-left sm:text-right",children:[e.jsx("div",{className:"text-xl font-bold text-primary",children:N(s.budget||"0")}),e.jsx("div",{className:"text-sm text-gray-500 mt-1",children:$(s.created_at)})]})]})}),e.jsx(T,{children:e.jsxs("div",{className:"flex flex-col sm:flex-row sm:justify-between sm:items-center gap-4",children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-x-4 gap-y-2 text-sm text-gray-600",children:[e.jsxs("span",{children:["Catégorie: ",s.category]}),s.quality_target&&e.jsxs("span",{children:["Qualité: ",s.quality_target]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(g,{className:"w-4 h-4"}),e.jsxs("span",{children:[s.bids_count||0," offre",(s.bids_count||0)!==1?"s":""]})]})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsxs(i,{variant:"outline",size:"sm",onClick:()=>d(s.id?.toString()||null),className:"flex items-center gap-1",children:[e.jsx(I,{className:"w-4 h-4"}),"Voir les détails"]}),e.jsxs(i,{variant:"outline",size:"sm",onClick:()=>n(`/edit-project/${s.id}`),className:"flex items-center gap-1",children:[e.jsx(L,{className:"w-4 h-4"}),"Modifier"]}),e.jsxs(i,{variant:"outline",size:"sm",onClick:()=>v(s.id),className:"flex items-center gap-1 text-red-600 hover:text-red-700",disabled:h.isPending,children:[e.jsx(R,{className:"w-4 h-4"}),"Supprimer"]})]})]})})]},s.id)):e.jsxs("div",{className:"text-center py-12",children:[e.jsx(g,{className:"w-16 h-16 text-gray-300 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-500 text-lg mb-4",children:"Vous n'avez pas encore créé de projets"}),e.jsxs(i,{onClick:()=>n(f.createMission),className:"bg-primary hover:bg-primary-dark text-white",children:[e.jsx(j,{className:"w-4 h-4 mr-2"}),"Créer mon premier projet"]})]})}),c&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50",children:e.jsx("div",{className:"bg-white rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto",children:e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-xl font-bold",children:"Détails du projet"}),e.jsx(i,{variant:"ghost",size:"sm",onClick:()=>d(null),children:"✕"})]}),e.jsxs("p",{className:"text-gray-600",children:["Détails du projet #",c," - Fonctionnalité à implémenter"]})]})})})]}):e.jsx("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8",children:e.jsxs("div",{className:"text-center py-12",children:[e.jsx("h2",{className:"text-2xl font-bold text-gray-900 mb-4",children:"Connexion requise"}),e.jsx("p",{className:"text-gray-600 mb-8",children:"Veuillez vous connecter pour voir vos demandes"}),e.jsx(i,{onClick:()=>n("/"),children:"Retour à l'accueil"})]})})}export{Y as default};
